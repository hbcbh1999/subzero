<!doctype html>
<html>

<head>
    <title>api overview</title>
</head>

<body>
    <h1>subZero Java Bindings</h1>
    <p>subZero is a set of libraries for building internal tools.</p>
    <p>For the full overview see <a href="https://docs.subzero.cloud/">docs.subzero.cloud</a></p>
    <h2>Java Bindings</h2>
    <p>This is the documentation for the java classes provided by subZero that wrap the C shared library</p>
    <p>These classes are used to create an autogenerated REST API (PostgREST compatibe) on top the database without the need for manually defining routes or controllers</p>
    <p>To get a good starting point (both backend and frontend configured and talking to eachother) we suggest starting with:</p>
    <pre><code>
    npx &#64;subzerocloud/scaffold new
    </code></pre>
    <p>
        and pick Java for the backend language
    </p>
    
    <p>Here is an example of the class used in the context of a springboot controller:</p>
    <pre><code>
    // ... springboot imports
    import cloud.subzero.rest.RestHandler;
    import cloud.subzero.SubzeroException;

    &#64;RestController
    &#64;RequestMapping("/rest")
    public class MyController {
        private final RestHandler rest;

        public MyController(DataSource dataSource) {
            try {
                // initialize subzero
                // this will introspect the database
                this.rest = new RestHandler(
                        dataSource,
                        "postgresql",
                        new String[] { "public" },
                        null,
                        true,
                        null,
                        null,
                        null);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }
        
        &#64;RequestMapping("/v1/**")
        public void handleRequest(HttpServletRequest req, HttpServletResponse res, &#64;AuthenticationPrincipal Jwt jwt) {
            try {
                // get the role from the jwt (you can use your own method to get the role)
                Map&lt;String, Object&gt; jwtClaims = jwt.getClaims();
                String role = (String) jwtClaims.get("role");

                // this is the env passed to the SQL context
                Map&lt;String, String&gt; env = this.subzero.getEnv(
                        role,
                        req,
                        jwtClaims);
                String[] envArray = new String[env.size() * 2];
                int i = 0;
                for (String key : env.keySet()) {
                    envArray[i++] = key;
                    envArray[i++] = env.get(key);
                }

                // handle the request
                this.rest.handleRequest("public", "/rest/v1/", role, req, res, envArray, null);
            }
            catch (SubzeroException e) {
                res.setStatus(e.getHttpStatusCode());
                res.setContentType("application/json");
                res.setCharacterEncoding("UTF-8");
                try {
                    res.getWriter().write(e.getMessage());
                } catch (Exception e2) {
                    e2.printStackTrace();
                }
            }
            catch (Exception e) {
                e.printStackTrace();
                res.setStatus(500);
                res.setContentType("application/json");
                res.setCharacterEncoding("UTF-8");
                try {
                    res.getWriter().write("{\"error\": \"Internal Server Error\"}");
                } catch (Exception e2) {
                    e2.printStackTrace();
                }
            }
        }
    }
    </code></pre>
</body>
</html>